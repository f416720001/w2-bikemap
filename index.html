<!DOCTYPE html>
<html>
<head>
	
	<title>自行車施工中</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.74.0/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/easy-autocomplete.min.css" integrity="sha512-TsNN9S3X3jnaUdLd+JpyR5yVSBvW9M6ruKKqJl5XiBpuzzyIMcBavigTAHaH50MJudhv5XIkXMOwBL7TbhXThQ==" crossorigin="anonymous" />
    <link rel="stylesheet" href="./leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="w2map.css">

 
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-ant-path" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.20.0/axios.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/3.2.0/sha.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.74.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/easy-autocomplete/1.3.5/jquery.easy-autocomplete.min.js" integrity="sha512-Z/2pIbAzFuLlc7WIt/xifag7As7GuTqoBbLsVTgut69QynAIOclmweT6o7pkxVoGGfLcmPJKn/lnxyMNKBAKgg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>

    <div id="map"></div>
    <div class="wrap">
        <div class="search">
           <input type="text" id="searchTerm" placeholder="找尋位置?">
           <button type="submit" class="searchButton">
             <i class="fa fa-search"></i>
          </button>
        </div>
     </div>


    <script>
        var usrLocation = [];
        var geoOptions = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        };

        function success(pos) {
            var crd = pos.coords;
            usrLocation = [crd.latitude, crd.longitude];
            console.log(usrLocation);
            renderMap(usrLocation);
        };

        function error(err) {
            console.warn('ERROR(' + err.code + '): ' + err.message);
        };

        navigator.geolocation.getCurrentPosition(success, error, geoOptions);

        function getAuthorizationHeader() {
            let AppID = '69121a1d8f714a5faa4f54c512bb459e';
            let AppKey = 'nYALaDjx1Au-PYCnZOnL-InFIZI';

            let GMTString = new Date().toGMTString();
            let ShaObj = new jsSHA('SHA-1', 'TEXT');
            ShaObj.setHMACKey(AppKey, 'TEXT');
            ShaObj.update('x-date: ' + GMTString);
            let HMAC = ShaObj.getHMAC('B64');
            let Authorization = 'hmac username=\"' + AppID + '\", algorithm=\"hmac-sha1\", headers=\"x-date\", signature=\"' + HMAC + '\"';
            return { 'Authorization': Authorization, 'X-Date': GMTString }; 
        }

        function readTextFile(file, callback) {
            var rawFile = new XMLHttpRequest();
            rawFile.overrideMimeType("application/json");
            rawFile.open("GET", file, true);
            rawFile.onreadystatechange = function() {
                if (rawFile.readyState === 4 && rawFile.status == "200") {
                    callback(rawFile.responseText);
                }
            }
            rawFile.send(null);
        }

        var searchOptions = { // 定義 EasyAutocomplete 的選取項目來源
            url: function (phrase) {
                return 'https://autosuggest.search.hereapi.com/v1/autosuggest?' + // Autosuggest 的 API URL
                    'q=' + phrase + // 接收使用者輸入的字串做搜尋
                    '&limit=5' + // 最多限定五筆回傳
                    '&lang=zh_TW' + // 限定台灣正體中文
                    '&at=' + map.getCenter().lat + ',' + map.getCenter().lng + // 使用目前地圖的中心點作為搜尋起始點
                    '&apikey=UoF0AQIZ-nGwU5R3UkPlq3xPxQ7r6gx9XFnuQ476tEo'; // 您的 HERE API KEY
            },
            listLocation: 'items', // 使用回傳的 item 作為選取清單
            getValue: 'title', // 在選取清單中顯示 title
            list: {
                onClickEvent: function () { // 按下選取項目之後的動作
                    var data = $("#searchTerm").getSelectedItemData();
                    map.flyTo(data.position, 18);
                }
            },
            requestDelay: 1000, // 延遲 100 毫秒再送出請求
            placeholder: '搜尋地點' // 預設顯示的字串
        };
        $('#searchTerm').easyAutocomplete(searchOptions); // 啟用 EasyAutocomplete 到 inpupbox 這個元件


        var map = L.map('map', {
            center: [25.045,121.516],
            zoom: 12
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://2021.thef2e.com/works">我們就是要組隊</a> contributors',
            minZoom: 1,
            maxZoom: 19
        }).addTo(map);

        L.control.locate({
            flyTo: true,
            initialZoomLevel: 17,
            strings: {
                popup: "您的位置"
            }

        }).addTo(map);


        function renderMap(usrLocation) {

            var greenIcon = new L.Icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            var redIcon = new L.Icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var markers = new L.MarkerClusterGroup().addTo(map);

            readTextFile("./Taipei.json", function(text){
                var data = JSON.parse(text);
                for(let i = 0; data.length > i; i++){
                    var mask = greenIcon;
                    
                    markers.addLayer(
                        L.marker([data[i].StationPosition.PositionLat, data[i].StationPosition.PositionLon], {icon: mask})
                        .bindPopup('<h1>' + data[i].StationUID + '  ' + data[i].StationName.Zh_tw + '</h1>' + '<p>' + data[i].AvailableRentBikes + '/' + data[i].BikesCapacity + '</p>')
                    );
                }
            });

            // data.items.forEach(function (item) { //1
            //     Object.keys(item).forEach(function(key) { //2
            //         if (!result[item.id]) result[item.id] = {}; //3
            //         result[item.id][key] = item[key]; //4
            //     });
            // })


            


            // `https://ptx.transportdata.tw/MOTC/v2/Bike/Station/NearBy?$top=30&$spatialFilter=nearby(${usrLocation[0]},${usrLocation[1]},550)&$format=JSON`
            axios.get('https://ptx.transportdata.tw/MOTC/v2/Bike/Availability/NearBy?$top=30&$spatialFilter=nearby(25.03,121.50,550)&$format=JSON', {headers: getAuthorizationHeader()})
                .then(function (response) {
                    let data = response.data;

                    for(let i = 0; data.length > i; i++){
                        var mask;
                        if(data[i].ServiceStatus  == 0 || data[i].ServiceStatus  == 2){
                            mask = redIcon;
                        } else{
                            mask = greenIcon;
                        }

                        uid = data[i].StationUID;
                        // console.log(uid);
                        
                        // markers.addLayer(L.marker([data[i].StationPosition.PositionLat, data[i].StationPosition.PositionLon], {icon: mask})
                        //                 .bindPopup('<h1>' + data[i].StationName.Zh_tw + '</h1>' + '<p>' + data[i].AvailableRentBikes + '/' + data[i].BikesCapacity + '</p>'));
                    }
                    // map.addLayer(markers);
                })
                .catch(function (error) {
                    console.log(error);
                })
                .finally(function () {
                    console.log('finally');
                });
        }


        
            
    </script>



</body>
</html>
